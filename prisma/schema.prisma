// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums 
enum RoleScope {
  SYSTEM
  COURSE
}

enum CourseVisibility {
  PUBLIC
  PRIVATE
}

enum UserCourseStatus {
  PENDING
  ENROLLED
  COMPLETED
  DROPPED
}

enum SubmissionStatus {
  SUBMITTED
  GRADED
}

enum FileOwnerType {
  USER
  COURSE
  LESSON
  ASSIGNMENT
}

enum ActorType {
  USER
  SYSTEM
  COURSE
}

// Models 

model Users {
  id         String        @id @default(uuid())
  fullName   String
  password   String
  email      String        @unique
  isActive   Boolean       @default(true)

  profile    UserProfile?
  passwordResets PasswordReset[]
  userRoles      UserRole[]
  courses        UserCourses[]
  courseRoles    CourseRole[]
  submissions    Submission[]
  notifications NotificationUser[]
  reviews        Review[]    @relation("reviewer")
  files          File[]      @relation("userFiles")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserProfile {
  id         String   @id @default(uuid())
  user        Users   @relation(fields: [userId], references: [id])
  userId      String  @unique
  grade       String?
  qualification String?
  avatarURL   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PasswordReset {
  id         String   @id @default(uuid())
  user       Users    @relation(fields: [userId], references: [id])
  userId     String
  tokenHash  String
  expiredAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())
}

model Roles {
  id          String   @id @default(uuid())
  name        String
  scope       RoleScope
  description String?

  rolePermissions RolePermission[]
  userRoles       UserRole[]
  courseRoles     CourseRole[] 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permissions {
  id             String           @id @default(uuid())
  permissionCode String           @unique
  description    String?

  rolePermissions RolePermission[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RolePermission {
  id           String     @id @default(uuid())
  role         Roles      @relation(fields: [roleId], references: [id])
  roleId       String
  permission   Permissions @relation(fields: [permissionId], references: [id])
  permissionId String

  @@unique([roleId, permissionId])
}

model UserRole {
  id     String @id @default(uuid())
  user   Users  @relation(fields: [userId], references: [id])
  userId String
  role   Roles  @relation(fields: [roleId], references: [id])
  roleId String

  @@unique([userId, roleId])
}

model CourseRole {
  id        String @id @default(uuid())
  user      Users  @relation(fields: [userId], references: [id])
  userId    String
  course    Courses @relation(fields: [courseId], references: [id])
  courseId  String
  role      Roles   @relation(fields: [roleId], references: [id])
  roleId    String

  @@unique([userId, courseId, roleId])
}

model Courses {
  id          String      @id @default(uuid())
  code        String?
  title       String
  description String?
  visibility  CourseVisibility @default(PUBLIC) 
  createdBy   String
  createdAt   DateTime    @default(now())

  models      Model[]     @relation("courseModels")
  users       UserCourses[]
  courseRoles CourseRole[]
  files       File[]      @relation("courseFiles")
}

model Model {
  id          String   @id @default(uuid())
  course      Courses  @relation("courseModels", fields: [courseId], references: [id])
  courseId    String
  title       String
  description String?
  visibility  CourseVisibility @default(PUBLIC)

  lessons     Lesson[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Lesson {
  id        String    @id @default(uuid())
  model     Model     @relation(fields: [modelId], references: [id])
  modelId   String
  title     String
  index     Int
  content   String?

  lessonResources LessonResource[]
  assignments     Assignment[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LessonResource {
  id       String @id @default(uuid())
  lesson   Lesson @relation(fields: [lessonId], references: [id])
  lessonId String
  title    String
  content  String?
  type      String   // pdf | video | link | file
  file      File?     @relation("lessonResourceFile", fields: [fileId], references: [id])
  fileId   String?    @unique 
  url      String?
}

model UserCourses {
  id          String           @id @default(uuid())
  user        Users            @relation(fields: [userId], references: [id])
  userId      String
  course      Courses          @relation(fields: [courseId], references: [id])
  courseId    String
  status      UserCourseStatus @default(ENROLLED)
  enrolledAt  DateTime?
  completedAt DateTime?
  finalScore  Int?

  @@unique([userId, courseId])
}

model Notification {
  id          String           @id @default(uuid())
  title       String
  content     String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  users       NotificationUser[]
}

model NotificationUser {
  id          String           @id @default(uuid())
  notificationId String
  userId      String
  isRead      Boolean @default(false)
  notification Notification    @relation(fields: [notificationId], references: [id])
  user        Users             @relation(fields: [userId], references: [id])
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Assignment {
  id           String    @id @default(uuid())
  lesson       Lesson    @relation(fields: [lessonId], references: [id])
  lessonId     String
  fileId       String?
  title        String
  description  String?
  maxScore     Int?
  allowLate    Boolean   @default(true)
  latePenalty  String?
  createdBy    String?
  openAt       DateTime?
  closeAt      DateTime?

  files File[] @relation("assignmentFiles")
  rubrics      Rubric[]
  submissions  Submission[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Rubric {
  id           String   @id @default(uuid())
  reviews      Review[]
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  assignmentId String
  title        String
  maxPointEach Int?
  weight       Float?    
  createdAt    DateTime @default(now())
}

model Submission {
  id            String           @id @default(uuid())
  assignment    Assignment       @relation(fields: [assignmentId], references: [id])
  assignmentId  String
  user          Users            @relation(fields: [userId], references: [id])
  userId        String
  fileId        String?
  attemptNumber Int?
  title         String?
  content       String?
  status        SubmissionStatus @default(SUBMITTED)
  submittedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  finalScore    Float?
  reviews       Review[]
}

model Review {
  id           String   @id @default(uuid())
  rubric       Rubric   @relation(fields: [rubricId], references: [id])
  rubricId     String
  submission   Submission @relation(fields: [submissionId], references: [id])
  submissionId String
  reviewer     Users      @relation("reviewer", fields: [reviewerId], references: [id])
  reviewerId   String
  point        Int?
  comment      String?
  createdAt    DateTime @default(now())

  @@unique([rubricId, submissionId])
}

model File {
  id            String      @id @default(uuid())
  
  user          Users?      @relation("userFiles", fields: [userId], references: [id], map: "fk_file_user")
  userId        String?

  course        Courses?    @relation("courseFiles", fields: [courseId], references: [id], map: "fk_file_course")
  courseId      String?

  lessonResource        LessonResource?     @relation("lessonResourceFile")
  lessonResourceId      String?

  assignment    Assignment? @relation("assignmentFiles", fields: [assignmentId], references: [id], map: "fk_file_assignment")
  assignmentId  String?

  path          String
  fileName      String
  fileType      String
  fileByte      Int?
  uploadedAt    DateTime    @default(now())


}

model LOG {
  id         String   @id @default(uuid())
  actorId    String
  actorType  ActorType
  action     String
  targetType String?
  targetId   String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
}